name: Env safety checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-node-env-check:
    name: Run node env check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node.js setup
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci

      - name: Run env check script
        env:
          NODE_ENV: production
        run: node ./scripts/check-no-dev-bypass.js

  scan-repo-for-sensitive-envs:
    name: Scan repository for sensitive envs
    runs-on: ubuntu-latest
    needs: run-node-env-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan repository for sensitive envs
        run: |
          set -euo pipefail
          echo "Scanning for dangerous env variables or service keys..."
          # search for DEV_ADMIN_BYPASS=true (case-insensitive), SUPABASE_SERVICE_ROLE_KEY, NEXTAUTH_SECRET, PAYSTACK_SECRET_KEY
          matches=$(grep -RIn --binary-files=without-match --exclude-dir=.git -E "DEV_ADMIN_BYPASS\s*=\s*true|SUPABASE_SERVICE_ROLE_KEY\s*=|NEXTAUTH_SECRET\s*=|PAYSTACK_SECRET_KEY\s*=" || true)
          if [ -n "$matches" ]; then
            echo "Found sensitive entries in repository:" >&2
            echo "$matches" >&2
            echo "Blocking merge: remove sensitive values from tracked files and use repository secrets instead." >&2
            exit 1
          else
            echo "No sensitive env flags or service keys found in the repository.";
          fi
