name: CI - build, lint, env-safety and smoke

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  env-safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run env-safety check
        run: node ./scripts/check-no-dev-bypass.js

  build-and-test:
    needs: env-safety
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm ci
      - name: Setup CI environment
        run: |
          cp .env.ci .env.local
          echo "SUPABASE_URL=https://placeholder.supabase.co" >> .env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=placeholder_key" >> .env.local
          echo "NEXTAUTH_SECRET=placeholder_secret" >> .env.local
          echo "PAYSTACK_SECRET_KEY=sk_test_placeholder" >> .env.local
          echo "RESEND_API_KEY=re_placeholder" >> .env.local
          echo "ADMIN_API_KEY=placeholder_admin" >> .env.local
      - name: Build
        run: npm run build --if-present
      - name: Run lint
        run: npm run lint --if-present || true

  smoke:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
      - name: Install deps
        run: npm ci
      - name: Run smoke funnel test against STAGING
        env:
          BASE_URL: ${{ secrets.STAGING_BASE_URL }}
          SMOKE_TEST_TOKEN: ${{ secrets.SMOKE_TEST_TOKEN }}
        run: |
          node scripts/smoke-funnel-test.js
